name: Invitation

on:
  issues:
    types: [labeled]
  push:
    branches: [main]  # 只在推送到 main 分支时触发
    paths:
      - '.github/workflows/invitation.yml'  # 只在修改 invitation.yml 时触发

jobs:
  automate_invite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Determine if invite should be sent on push
        id: check_push
        run: |
          echo "::set-output name=should_invite::false"
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
            for FILE in .github/workflows/invitation.yml README.md; do
              if [[ "$CHANGED_FILES" == *"$FILE"* ]]; then
                echo "::set-output name=should_invite::true"
                break
              fi
            done
          fi

      - name: Invite on label or specific push
        if: ${{ github.event_name == 'issues' || (github.event_name == 'push' && steps.check_push.outputs.should_invite == 'true') }}
        id: invite
        uses: vj-abigo/invite-on-label@v1.2
        with:
          organization: Magic-Academy
          label: invite me to the organisation
          repo-token: ${{ secrets.PROFILE_STATS_TOKEN }}
          comment: |
            <b>Invitation sent to join the GitHub Organisation. Welcome to the community 🎉</b>
            <br><br>
            Don't forget after accepting to make it public so it appears on your GitHub profile for everyone else to see.
            You can do this by finding your name in the GitHub organisation list and change the dropdown to public:
            https://github.com/orgs/Magic-Academy/people
        env:
          INVITE_TOKEN: ${{ secrets.PROFILE_STATS_TOKEN }}

      - name: Check invitation status
        if: steps.invite.outcome == 'success'
        run: echo "Invitation successfully sent!"