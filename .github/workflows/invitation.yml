name: Invitation

on:
  issues:
    types: [labeled]
  push:
    branches: [main]  # 只在推送到 main 分支时触发
    paths:
      - '.github/workflows/invitation.yml'  # 只在修改 invitation.yml 时触发
  schedule:
    - cron: '0 0 * * 0'  # 每周日 UTC 时间 00:00 运行

jobs:
  automate_invite:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Invite on label or specific push
        id: invite
        uses: vj-abigo/invite-on-label@v1.2
        if: ${{ github.event_name == 'issues' || (github.event_name == 'push' && contains(github.event.push.changes.*.filename, '.github/workflows/invitation.yml')) }}
        with:
          organization: Magic-Academy
          label: invite me to the organisation
          repo-token: ${{ secrets.PROFILE_STATS_TOKEN }}
          comment: |
            <b>Invitation sent to join the GitHub Organisation. Welcome to the community 🎉</b>
            <br><br>
            Don't forget after accepting to make it public so it appears on your GitHub profile for everyone else to see.
            You can do this by finding your name in the GitHub organisation list and change the dropdown to public:
            https://github.com/orgs/Magic-Academy/people
        env:
          INVITE_TOKEN: ${{ secrets.PROFILE_STATS_TOKEN }}

      - name: Check invitation status
        if: steps.invite.outcome == 'success'
        run: echo "Invitation successfully sent!"

  check_existing_issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Process existing issues
        run: node ./.github/scripts/process-existing-issues.js
        env:
          PROFILE_STATS_TOKEN: ${{ secrets.PROFILE_STATS_TOKEN }}